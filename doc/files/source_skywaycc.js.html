<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>source\skywaycc.js - skywaycc</title>
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:400,600' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/ico" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.svg" title="skywaycc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <span>
                API Docs for: <a href="http://temasys.github.io">0.1.0</a>
            </span>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Skyway.html">Skyway</a></li>
            
                <li><a href="../classes/SkywayCC.html">SkywayCC</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: source\skywaycc.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @class SkywayCC
 * @extends Skyway
 * @requires Skyway
 * @for Skyway
 */
(function() {
  /**
   * SkywayCC is a implementation for Skyway to create a control center like
   * use-case. Things to take note are:
   * - The defaultRoom is the main lobby where all the peers connect to from the
   *   beginning. If no defaultRoom specified, the lobby would be the apiKey.
   * - Call {{#crossLink &quot;SkywayCC/connect:method&quot;}}connect(){{/crossLink}} after
   *   {{#crossLink &quot;Skyway/init:method&quot;}}init(){{/crossLink}} to connect peer
   *   to the main lobby.
   * @class SkywayCC
   * @constructor
   * @example
   *   // Getting started on how to use Skyway
   *   // Note that the defaultRoom is required for SkywayCC if you want
   *   // To specify a specific lobby room name
   *   var SkywayDemo = new SkywayCC();
   *   SkywayDemo.init({
   *     defaultRoom: &#x27;lobby&#x27;,
   *     apiKey: &#x27;apiKey&#x27;
   *   });
   */
  function SkywayCC() {
    if (!Skyway) {
      console.error(&#x27;API - Skyway is not loaded. Please load Skyway first before SkywayCC.&#x27;);
    }
    /**
     * Version of SkywayCC
     * @attribute VERSION
     * @type String
     * @readOnly
     * @since 0.1.0
     */
    this.VERSION = &#x27;@@version&#x27;;
    /**
     * The ready state of the peer&#x27;s call if they are ready to join the room.
     * @attribute CALL_READY_STATE
     * @type JSON
     * @param {Integer} LOBBY         Peer is in lobby
     * @param {Integer} REQUEST_CALL  Agent requests to start the call
     * @param {Integer} START_CALL    Agent and Client is ready to start the call.
     * @param {Integer} ACCEPTED_CALL Client accepted the call
     * @param {Integer} REJECTED_CALL Client rejected the call.
     * @param {Intger}
     * @readOnly
     * @since 0.1.0
     */
    this.CALL_READY_STATE = {
      LOBBY: 1,
      REQUEST_CALL: 2,
      ACCEPTED_CALL: 3,
      START_CALL: 4,
      REJECTED_CALL: -1
    };
    /**
     * Internal array of peer requests
     * @attribute _peerRequests
     * @type Array
     * @required
     * @private
     * @since 0.1.0
     */
    this._peerRequests = [];
    /**
     * User object
     * @type JSON
     * @param {String} id User Session ID
     * @param {Object} peer PeerConnection object
     * @param {String} sid User Secret Session ID
     * @param {String} apiOwner Owner of the room
     * @param {Array} streams Array of User&#x27;s MediaStream
     * @param {String} timestamp User&#x27;s timestamp
     * @param {String} token User access token
     * @param {JSON} info Optional. User information
     * @param {JSON} info.settings Peer stream settings
     * @param {Boolean|JSON} info.settings.audio
     * @param {Boolean} info.settings.audio.stereo
     * @param {Boolean|JSON} info.settings.video
     * @param {Bolean|JSON} info.settings.video.resolution [Rel: SkywayCC.VIDEO_RESOLUTION]
     * @param {Integer} info.settings.video.resolution.width
     * @param {Integer} info.settings.video.resolution.height
     * @param {Integer} info.settings.video.frameRate
     * @param {JSON} info.mediaStatus Peer stream status.
     * @param {Boolean} info.mediaStatus.audioMuted If Peer&#x27;s Audio stream is muted.
     * @param {Boolean} info.mediaStatus.videoMuted If Peer&#x27;s Video stream is muted.
     * @param {String|JSON} info.userData Peer custom data
     * @param {JSON} info.status Peer call status object.
     * @param {String} info.status.userStatus The current ready state of the user&#x27;s call.
     *   [Rel: SkywayCC.CALL_READY_STATE]
     * @param {String} info.status.userTargetPeerId PeerId the call to direct to.
     * @param {String} info.status.userType Peer type [Rel: SkywayCC.PEER_TYPE]
     * @param {String} info.status.userTargetRoom The targeted Room to join. Default is
     *   info.status.userTargetPeerId if not specified.
     * @required
     * @private
     * @since 0.1.0
     */
    this._user = null;
    /**
     * If peer is agent or customer. Types are:
     * @attribute PEER_TYPE
     * @type JSON
     * @param {String} CUSTOMER  User is customer
     * @param {String} AGENT     User is agent
     * @readOnly
     * @since 0.1.0
     */
    this.PEER_TYPE = {
      CLIENT: &#x27;client&#x27;,
      AGENT: &#x27;agent&#x27;
    };
    /**
     * User custom events stored
     * @attribute CUSTOM_EVENT
     * @type JSON
     * @readOnly
     * @final
     * @since 0.1.0
     */
    this.CUSTOM_EVENT = {};
    /**
     * Connect user to the main lobby.
     * Please call this only after calling
     * {{#crossLink &quot;Skyway/init:method&quot;}}init(){{/crossLink}}
     * @method connect
     * @param {JSON|String} userData The User Data
     * @param {JSON} userEvents The events that would be recognised by Skyway
     * @param {String} userType Deprecated. The peer type [Rel: SkywayCC.PEER_TYPE].
     *   This would be removed from the specs once agent and client is identified
     *   from the request url.
     * @example
     *   var EVENT = {
     *     STARTING: &#x27;starting&#x27;,
     *     ON_HOLD: &#x27;onhold&#x27;,
     *     IN_CALL: &#x27;incall&#x27;
     *   };
     *   SkywayDemo.connect({
     *     &#x27;displayName&#x27;: &#x27;Agent Bob&#x27;,
     *     &#x27;timeStamp&#x27;: (new Date()).toISOString,
     *     &#x27;status&#x27;: EVENT.STARTING
     *   }, EVENT, SkywayDemo.PEER_TYPE.AGENT);
     * @trigger peerJoined, peerRequest
     * @for SkywayCC
     * @required
     * @since 0.1.0
     */
    this.connect = function (userData, userEvents, userType) {
      var self = this;
      var checkReadyState = setInterval(function() {
        if (self._readyState === self.READY_STATE_CHANGE.COMPLETED &amp;&amp;
          self._user) {
          clearInterval(checkReadyState);
          self._user.info = self._user.info || {};
          self._user.info.status = {
            userStatus: self.CALL_READY_STATE.LOBBY,
            userType: userType
          };
          self.joinRoom({
            user: userData,
            audio: false,
            video: false
          });
          self.CUSTOM_EVENT = (typeof userEvents === &#x27;object&#x27;) ?
            userEvents : {};
        }
      });
    };
  }
  // Initialize SkywayCC as Skyway and start
  SkywayCC.prototype = new Skyway();
  this.SkywayCC = SkywayCC;

  /**
   * Throw an event with the received private message
   * @method _privateMessageHandler
   * @param {JSON} message
   * @param {String} message.sender The senderPeerId.
   * @param {JSON|String} message.data The Data broadcasted
   * @param {String} message.userStatus For peerRequest event.
   * @param {String} message.mid TargetMid
   * @param {String} message.cid The credentialId
   * @param {String} message.rid RoomId
   * @param {String} message.type Message type
   * @trigger privateMessage
   * @private
   * @since 0.1.0
   */
  SkywayCC.prototype._privateMessageHandler = function(message) {
    if (message.userStatus) {
      this._userStatusHandler(message);
    } else {
      this._trigger(&#x27;privateMessage&#x27;, message.data, message.sender,
        message.target, false);
    }
  };

  /**
   * Throw an event with the received private message
   * @method _publicMessageHandler
   * @param {JSON} message
   * @param {String} message.sender The senderPeerId.
   * @param {JSON|String} message.data The Data broadcasted
   * @param {JSON}   message.userStatus For peerRequest event
   * @param {String} message.mid TargetMid
   * @param {String} message.cid The credentialId
   * @param {String} message.rid RoomId
   * @param {String} message.type Message type
   * @trigger publicMessage
   * @private
   * @since 0.1.0
   */
  SkywayCC.prototype._publicMessageHandler = function(message) {
    if (message.userStatus) {
      this._userStatusHandler(message);
    } else {
      this._trigger(&#x27;publicMessage&#x27;, message.data, message.sender, false);
    }
  };

  /**
   * Handles all user status event changes
   * @method _userStatusHandler
   * @param {JSON} message
   * @param {String} message.sender The senderPeerId.
   * @param {JSON|String} message.data The Data broadcasted
   * @param {String} message.userStatus For peerRequest event.
   * @param {String} message.mid TargetMid
   * @param {String} message.cid The credentialId
   * @param {String} message.rid RoomId
   * @param {String} message.type Message type
   * @trigger privateMessage
   * @private
   * @since 0.1.0
   */
  SkywayCC.prototype._userStatusHandler = function(message) {
    if (message.target) {
      if (message.data.userStatus &gt;= this.CALL_READY_STATE.REQUEST_CALL) {
        // Verify it&#x27;s sending to the correct peer and also not to me
        if (message.data.userTargetPeerId === this._user.sid) {
          this._peerRequests[message.sender] = message.data;
          this._user.info.status.userStatus = message.data.userStatus;
          this._trigger(&#x27;peerRequest&#x27;, message.sender, message.data, false);
        } else {
          console.info(&#x27;API [&#x27; + message.mid +
            &#x27;] - Dropped request because targetPeerId does not match.&#x27;);
        }
      } else {
        this._peerRequests[message.sender] = message.data;
        this._user.status.userStatus = message.data.userStatus;
        this._trigger(&#x27;peerRequest&#x27;, message.sender, message.data, false);
      }
    } else {
      this._peerRequests[message.sender] = message.data;
      // Customer cannot see agent information
      if (message.data.userType === this.PEER_TYPE.AGENT) {
        this._trigger(&#x27;peerRequest&#x27;, message.sender, message.data, false);
      }
    }
  };

  /**
   * Trigger a event that is parsed in
   * {{#crossLink &quot;SkywayCC/connect:method&quot;}}connect(){{/crossLink}} for self.
   * Note: It is only received by self.
   * Use {{#crossLink &quot;Skyway/sendPrivateMessage:method&quot;}}sendPrivateMessage(){{/crossLink}}
   * to broadcast a private event or
   * {{#crossLink &quot;Skyway/sendPublicMessage:method&quot;}}sendPublicMessage(){{/crossLink}}
   * to broadcast a public event.
   * @method startEvent
   * @param {JSON|String} userData The peer&#x27;s updated user data to send over.
   * @param {String} userEvent The event to be trigged.
   * @param {JSON|String|Array} userEventParams The event params.
   * @example
   *   var userData = SkywayDemo.getUserData().userData;
   *   userData.status = &#x27;newEvent&#x27;;
   *   SkywayDemo.startEvent(userData, &#x27;newEvent&#x27;, {
   *     &#x27;startAdvert&#x27;: true,
   *     &#x27;UUID&#x27;: &#x27;XXXX-XXX-XXX&#x27;
   *   });
   *   SkywayDemo.on(&#x27;newEvent&#x27;, function (params) {
   *     // ....
   *   });
   * @trigger [customEvent]
   * @since 0.1.0
   */
  SkywayCC.prototype.startEvent = function (userData, userEvent, userEventParams) {
    var self = this;
    setTimeout(function () {
      self.setUserData(userData);
    }, 200);
    for (var e in this._events) {
      if (this._events[e] === userEvent) {
        console.error(&#x27;API - You cannot call a Skyway event.&#x27;);
        return;
      }
    }
    for (var ce in this.CUSTOM_EVENT) {
      if (this.CUSTOM_EVENT[ce] === userEvent) {
        this._trigger(userEvent, userEventParams);
        return;
      }
    }
    console.error(&#x27;API - You cannot call an event that is not specified.&#x27;);
  };

  /**
   * Step 1: Agent requests to start the call to client
   * @method agentRequestCall
   * @param {String} clientPeerId Client peerId to start call to.
   * @param {String} room Room to ask client to join in
   * @example
   *   // Example 1: Request call
   *   SkywayDemo.agentRequestCall(peerId);
   *
   *   // Example 2: Request call with a specific room
   *   SkywayDemo.agentRequestCall(peerId, room);
   * @trigger peerRequest
   * @since 0.1.0
   */
  SkywayCC.prototype.agentRequestCall = function (clientPeerId, room) {
    if (!this._user) {
      return;
    } else if (!this._user.info) {
      return;
    } else if (!this._user.info.status) {
      return;
    }
    if (this._user.info.status.userType !== this.PEER_TYPE.AGENT) {
      return;
    }
    this._user.info.status.userStatus = this.CALL_READY_STATE.REQUEST_CALL;
    this._user.info.status.userTargetPeerId = clientPeerId;
    this._user.info.status.userTargetRoom = room || clientPeerId;
    this._sendMessage({
      cid: this._key,
      mid: this._user.sid,
      rid: this._room.id,
      sender: this._user.sid,
      data: this._user.status,
      target: ((clientPeerId) ? clientPeerId : this._user.sid),
      type: this.SIG_TYPE.PRIVATE_MESSAGE,
      userStatus: true
    });
    this._trigger(&#x27;peerRequest&#x27;, this._user.sid, this._user.status, true);
  };

  /**
   * Step 2: Client to accept or reject the call.
   * @method acceptRequestCall
   * @param {String} agentPeerId PeerId of the agent.
   * @param {Boolean} accept If client accepts agent request or not.
   * @example
   *   SkywayDemo.on(&#x27;peerRequest&#x27;, function (peerId, peerStatus, isSelf)) {
   *     if (!isSelf) {
   *       if (peerStatus.userStatus === SkywayDemo.CALL_STATUS.REQUEST_CALL) {
   *         var result = confirm(&#x27;Do you want to accept the call?&#x27;);
   *         SkywayDemo.acceptRequestCall(peerId, result);
   *       }
   *     }
   *   });
   * @trigger peerRequest
   * @since 0.1.0
   */
  SkywayCC.prototype.acceptRequestCall = function (agentPeerId, accept) {
    if (this._user.status.userType === this.PEER_TYPE.AGENT) {
      return;
    }
    this._user.status.userStatus = (accept) ? this.CALL_READY_STATE.ACCEPTED_CALL
      : this.CALL_READY_STATE.REJECTED_CALL;
    this._user.status.userTargetPeerId = agentPeerId;
    this._user.status.userTargetRoom = this._peerRequests[agentPeerId].userTargetRoom;
    this._sendMessage({
      cid: this._key,
      data: this._user.status,
      mid: this._user.sid,
      rid: this._room.id,
      sender: this._user.sid,
      target: ((agentPeerId) ? agentPeerId : this._user.sid),
      type: this.SIG_TYPE.PRIVATE_MESSAGE,
      userStatus: true
    });
    this._trigger(&#x27;peerRequest&#x27;, this._user.sid, this._user.status, true);
  };

  /**
   * Step 3: Start the call. You may call method
   * {{#crossLink &quot;Skyway/init:method&quot;}}joinRoom(){{/crossLink}} to start the call.
   * Request a call for agent
   * @method startRequestCall
   * @param {String} room Room to ask client to join in
   * @param {Function} callback Callback after the room is ready to join
   * @example
   *   SkywayDemo.on(&#x27;peerRequest&#x27;, function (peerId, peerStatus, isSelf)) {
   *     if (!isSelf) {
   *       if (peerStatus.userStatus === SkywayDemo.CALL_STATUS.START_CALL) {
   *         SkywayDemo.startRequestCall(peerId, function (targetRoom) {
   *           SkywayDemo.joinRoom(targetRoom, {
   *             audio: true,
   *             video: true
   *           });
   *         });
   *       }
   *     }
   *   });
   * @trigger peerRequest
   * @since 0.1.0
   */
  SkywayCC.prototype.startRequestCall = function (targetPeerId, callback) {
    var self = this;
    var leaveRoom = function () {
      for (var pc_index in self._peerConnections) {
        if (self._peerConnections.hasOwnProperty(pc_index)) {
          self._removePeer(pc_index);
        }
      }
      self._in_room = false;
      self._closeChannel();
      callback(self._user.status.userTargetRoom);
    };
    if (self._user.status.userType === self.PEER_TYPE.AGENT) {
      self._user.status.userStatus = self.CALL_READY_STATE.START_CALL;
      self._sendMessage({
        cid: self._key,
        mid: self._user.sid,
        rid: self._room.id,
        sender: self._user.sid,
        data: self._user.status,
        target: ((targetPeerId) ? targetPeerId : self._user.sid),
        type: self.SIG_TYPE.PRIVATE_MESSAGE,
        userStatus: true
      });
      self._trigger(&#x27;peerRequest&#x27;, self._user.sid, self._user.status, true);
      setTimeout(function () {
        leaveRoom();
      }, 3500);
    } else {
      leaveRoom();
    }
  };
  /* Syntactically private variables and utility functions */
  /**
   * Event fired when a peer request has changed changed.
   * @event peerRequest
   * @param {String} peerId PeerId of the peer that has a call ready state changed.
   * @param {JSON} peerStatus Peer&#x27;s peerStatus object.
   * @param {JSON} peerStatus.userStatus Peer userStatus [Rel: SkywayCC.CALL_STATUS]
   * @param {Boolean|JSON} peerStatus.userType Peer user type [Rel: SkywayCC.PEER_TYPE]
   * @param {String|JSON} peerInfo.userTargetPeerId Peer target directed call to.
   * @param {Boolean} isSelf Is the Peer self.
   * @since 0.1.0
   */
  SkywayCC.prototype._events.peerRequest = [];

}).call(this);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
