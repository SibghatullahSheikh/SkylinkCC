/*! skylinkcc - v0.3.0 - 2014-11-18 */
(function(){function SkylinkCC(){this.VERSION="0.3.0",this._in_lobby=!1,this._defaultLobbyRoom="MAIN",this._lobbyRoom=!1,this.CALL_READY_STATE={LOBBY:1,REQUEST_CALL:2,ACCEPTED_CALL:3,START_CALL:4,REJECTED_CALL:-1},this._user=null,this._temp=[],this.PEER_TYPE={CLIENT:"client",AGENT:"agent"},this.connect=function(lobbyRoom,userData,peerType){var self=this,checkReadyState=setInterval(function(){self._readyState===self.READY_STATE_CHANGE.COMPLETED&&self._user&&(clearInterval(checkReadyState),self._temp.userCall={status:self.CALL_READY_STATE.LOBBY,peerType:peerType||self.PEER_TYPE.CLIENT},self._lobbyRoom=lobbyRoom||self._defaultLobbyRoom,self.joinRoom(self._lobbyRoom,{userData:userData,audio:!1,video:!1}))})}}SkylinkCC.prototype=new Skyway,this.SkylinkCC=SkylinkCC,SkylinkCC.prototype._inRoomHandler=function(message){var self=this;self._room.pcHelper.pcConfig=self._setFirefoxIceServers(message.pc_config),self._in_room=!0,self._user.sid=message.sid,self._user.info.call?self._user.info.call.status===self.CALL_READY_STATE.LOBBY&&(self._in_lobby=!0):(self._temp.userCall&&(self._user.info.call=self._temp.userCall,delete self._temp.userCall),self._temp.userData&&(self._user.info.userData=self._temp.userData,delete self._temp.userData)),self._trigger("peerJoined",self._user.sid,self._user.info,!0);var params={type:self.SIG_TYPE.ENTER,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser.browser,version:window.webrtcDetectedBrowser.version,userInfo:self._user.info};self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,self._user.sid),self._sendMessage(params)},SkylinkCC.prototype._privateMessageHandler=function(message){var targetMid=message.mid;message.callStatus?this._callStatusHandler(targetMid,message,!0):this._trigger("privateMessage",message.data,targetMid,message.target,!1)},SkylinkCC.prototype._publicMessageHandler=function(message){var targetMid=message.mid;message.callStatus?this._callStatusHandler(targetMid,message,!1):this._trigger("publicMessage",message.data,targetMid,!1)},SkylinkCC.prototype._callStatusHandler=function(targetMid,message,isPrivate){var call=message.data,checkPrivate=call.status>=this.CALL_READY_STATE.REQUEST_CALL?call.targetPeerId===this._user.sid:!0;isPrivate&&checkPrivate?(this._peerInformations[targetMid].call=call,this._user.info.call.status=call.status,this._trigger("peerCallRequest",targetMid,this._peerInformations[targetMid],!1)):isPrivate||(this._peerInformations[message.sender].call=call,call.peerType===this.PEER_TYPE.AGENT&&this._trigger("peerCallRequest",targetMid,this._peerInformations[targetMid],!1))},SkylinkCC.prototype.startPeerEvent=function(userData,event){var self=this;for(var e in this._events)if(this._events[e]===event.name)return;event.name&&setTimeout(function(){self.setUserData(userData),self._trigger(event.name,event.params)},200)},SkylinkCC.prototype._handleCall=function(peerId,options,callback){this._user&&this._user.info&&this._user.info.call&&this._user.info.call.peerType===options.peerType&&(this._user.info.call.status=options.status||this._user.info.call.status,this._user.info.call.targetPeerId=options.targetPeerId||this._user.info.call.targetPeerId,this._user.info.call.targetRoom=options.targetRoom||this._user.info.call.targetRoom||null,this._sendMessage({cid:this._key,mid:this._user.sid,rid:this._room.id,data:this._user.info.call,target:peerId,type:this.SIG_TYPE.PRIVATE_MESSAGE,callStatus:!0}),this._trigger("peerCallRequest",this._user.sid,this._user.info,!0),callback&&callback())},SkylinkCC.prototype.agentRequestCall=function(clientPeerId,room){this._handleCall(clientPeerId,{status:this.CALL_READY_STATE.REQUEST_CALL,targetPeerId:clientPeerId,targetRoom:room||clientPeerId,peerType:this.PEER_TYPE.AGENT})},SkylinkCC.prototype.acceptRequestCall=function(agentPeerId,accept){this._handleCall(agentPeerId,{status:accept?this.CALL_READY_STATE.ACCEPTED_CALL:this.CALL_READY_STATE.REJECTED_CALL,targetPeerId:agentPeerId,targetRoom:this._peerInformations[agentPeerId].call.targetRoom,peerType:this.PEER_TYPE.CLIENT})},SkylinkCC.prototype.startRequestCall=function(targetPeerId,callback){var peerInfo,self=this,doLeaveRoom=function(){var userInfo=self._user.info;self.leaveRoom(),self._in_lobby=!1,self._temp.userCall=userInfo.call,self._temp.userData=userInfo.userData,callback(userInfo,peerInfo)};self._user.info.call.peerType===self.PEER_TYPE.AGENT?this._handleCall(targetPeerId,{status:self.CALL_READY_STATE.START_CALL,targetPeerId:targetPeerId,peerType:this.PEER_TYPE.AGENT},function(){peerInfo=self._peerInformations[targetPeerId],setTimeout(function(){doLeaveRoom()},3500)}):(peerInfo=self._peerInformations[targetPeerId],doLeaveRoom())},SkylinkCC.prototype._events.peerCallRequest=[],SkywayCC=SkylinkCC}).call(this);