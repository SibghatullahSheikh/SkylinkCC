/*! skywaycc - v0.1.0 - 2014-08-20 */
(function(){function SkywayCC(){this.VERSION="0.1.0",this.CALL_READY_STATE={LOBBY:1,REQUEST_CALL:2,ACCEPTED_CALL:3,START_CALL:4,REJECTED_CALL:-1},this._peerRequests=[],this._user=null,this.PEER_TYPE={CLIENT:"client",AGENT:"agent"},this.CUSTOM_EVENT={},this.connect=function(userData,userEvents,userType){var self=this,checkReadyState=setInterval(function(){self._readyState===self.READY_STATE_CHANGE.COMPLETED&&self._user&&(clearInterval(checkReadyState),self._user.info=self._user.info||{},self._user.info.status={userStatus:self.CALL_READY_STATE.LOBBY,userType:userType},self.joinRoom({user:userData,audio:!1,video:!1}),self.CUSTOM_EVENT="object"==typeof userEvents?userEvents:{})})}}SkywayCC.prototype=new Skyway,this.SkywayCC=SkywayCC,SkywayCC.prototype._privateMessageHandler=function(message){message.userStatus?this._userStatusHandler(message):this._trigger("privateMessage",message.data,message.sender,message.target,!1)},SkywayCC.prototype._publicMessageHandler=function(message){message.userStatus?this._userStatusHandler(message):this._trigger("publicMessage",message.data,message.sender,!1)},SkywayCC.prototype._userStatusHandler=function(message){message.target?message.data.userStatus>=this.CALL_READY_STATE.REQUEST_CALL?message.data.userTargetPeerId===this._user.sid&&(this._peerRequests[message.sender]=message.data,this._user.info.status.userStatus=message.data.userStatus,this._trigger("peerRequest",message.sender,message.data,!1)):(this._peerRequests[message.sender]=message.data,this._user.status.userStatus=message.data.userStatus,this._trigger("peerRequest",message.sender,message.data,!1)):(this._peerRequests[message.sender]=message.data,message.data.userType===this.PEER_TYPE.AGENT&&this._trigger("peerRequest",message.sender,message.data,!1))},SkywayCC.prototype.startEvent=function(userData,userEvent,userEventParams){var self=this;setTimeout(function(){self.setUserData(userData)},200);for(var e in this._events)if(this._events[e]===userEvent)return;for(var ce in this.CUSTOM_EVENT)if(this.CUSTOM_EVENT[ce]===userEvent)return void this._trigger(userEvent,userEventParams)},SkywayCC.prototype.agentRequestCall=function(clientPeerId,room){this._user&&this._user.info&&this._user.info.status&&this._user.info.status.userType===this.PEER_TYPE.AGENT&&(this._user.info.status.userStatus=this.CALL_READY_STATE.REQUEST_CALL,this._user.info.status.userTargetPeerId=clientPeerId,this._user.info.status.userTargetRoom=room||clientPeerId,this._sendMessage({cid:this._key,mid:this._user.sid,rid:this._room.id,sender:this._user.sid,data:this._user.status,target:clientPeerId?clientPeerId:this._user.sid,type:this.SIG_TYPE.PRIVATE_MESSAGE,userStatus:!0}),this._trigger("peerRequest",this._user.sid,this._user.status,!0))},SkywayCC.prototype.acceptRequestCall=function(agentPeerId,accept){this._user.status.userType!==this.PEER_TYPE.AGENT&&(this._user.status.userStatus=accept?this.CALL_READY_STATE.ACCEPTED_CALL:this.CALL_READY_STATE.REJECTED_CALL,this._user.status.userTargetPeerId=agentPeerId,this._user.status.userTargetRoom=this._peerRequests[agentPeerId].userTargetRoom,this._sendMessage({cid:this._key,data:this._user.status,mid:this._user.sid,rid:this._room.id,sender:this._user.sid,target:agentPeerId?agentPeerId:this._user.sid,type:this.SIG_TYPE.PRIVATE_MESSAGE,userStatus:!0}),this._trigger("peerRequest",this._user.sid,this._user.status,!0))},SkywayCC.prototype.startRequestCall=function(targetPeerId,callback){var self=this,leaveRoom=function(){for(var pc_index in self._peerConnections)self._peerConnections.hasOwnProperty(pc_index)&&self._removePeer(pc_index);self._in_room=!1,self._closeChannel(),callback(self._user.status.userTargetRoom)};self._user.status.userType===self.PEER_TYPE.AGENT?(self._user.status.userStatus=self.CALL_READY_STATE.START_CALL,self._sendMessage({cid:self._key,mid:self._user.sid,rid:self._room.id,sender:self._user.sid,data:self._user.status,target:targetPeerId?targetPeerId:self._user.sid,type:self.SIG_TYPE.PRIVATE_MESSAGE,userStatus:!0}),self._trigger("peerRequest",self._user.sid,self._user.status,!0),setTimeout(function(){leaveRoom()},3500)):leaveRoom()},SkywayCC.prototype._events.peerRequest=[]}).call(this);