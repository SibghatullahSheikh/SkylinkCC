/*! skylinkcc - v0.3.0 - 2014-11-18 */
(function(){function SkylinkCC(){Skylink||log.error("Skylink is not loaded. Please load Skylink first before SkylinkCC.")}SkylinkCC.prototype=new Skylink,this.SkylinkCC=SkylinkCC,SkylinkCC.prototype.VERSION="0.3.0",SkylinkCC.prototype._in_lobby=!1,SkylinkCC.prototype._defaultLobbyRoom="MAIN",SkylinkCC.prototype._lobbyRoom=!1,SkylinkCC.prototype.CALL_READY_STATE={LOBBY:1,REQUEST_CALL:2,ACCEPTED_CALL:3,START_CALL:4,REJECTED_CALL:-1},SkylinkCC.prototype._user=null,SkylinkCC.prototype._temp=[],SkylinkCC.prototype.PEER_TYPE={CLIENT:"client",AGENT:"agent"};var _LOG_KEY="SkylinkJS",_logLevel=4,_enableDebugMode=!1,_logFn=function(logLevel,message,debugObject){var levels=["error","warn","info","log","debug"],outputLog=_LOG_KEY;if(_logLevel>=logLevel){if("object"==typeof message){if(outputLog+=message[0]?" ["+message[0]+"] -":" -",outputLog+=message[1]?" <<"+message[1]+">>":"",message[2])if(outputLog+=" ","object"==typeof message[2])for(var i=0;i<message[2].length;i++)outputLog+="("+message[2][i]+")";else outputLog+="("+message[2]+")";outputLog+=" "+message[3]}else outputLog+=" - "+message;{"++ "+levels[logLevel].toUpperCase()+" ++  "+outputLog}if(logLevel="undefined"==typeof console[levels[logLevel]]?3:logLevel,_enableDebugMode){"undefined"==typeof console.trace?logLevel[3]:"trace"}}},log={debug:function(message,object){_logFn(4,message,object)},log:function(message,object){_logFn(3,message,object)},info:function(message,object){_logFn(2,message,object)},warn:function(message,object){_logFn(1,message,object)},error:function(message,object){_logFn(0,message,object)}};SkylinkCC.prototype.connect=function(lobbyRoom,userData,peerType){var self=this,checkReadyState=setInterval(function(){self._readyState===self.READY_STATE_CHANGE.COMPLETED&&self._user&&(clearInterval(checkReadyState),self._temp.userCall={status:self.CALL_READY_STATE.LOBBY,peerType:peerType||self.PEER_TYPE.CLIENT},self._lobbyRoom=lobbyRoom||self._defaultLobbyRoom,self.joinRoom(self._lobbyRoom,{userData:userData,audio:!1,video:!1}))})},SkylinkCC.prototype._inRoomHandler=function(message){var self=this;log.log(["Server",null,message.type,"User is now in the room and functionalities are now available. Config received:"],message.pc_config),self._room.connection.peerConfig=self._setIceServers(message.pc_config),self._inRoom=!0,self._user.sid=message.sid,self._user.info.call?self._user.info.call.status===self.CALL_READY_STATE.LOBBY&&(self._in_lobby=!0):(self._temp.userCall&&(self._user.info.call=self._temp.userCall,delete self._temp.userCall),self._temp.userData&&(self._user.info.userData=self._temp.userData,delete self._temp.userData)),self._trigger("peerJoined",self._user.sid,self._user.info,!0),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.ENTER,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,userInfo:self._user.info}),log.log("Sending enter"),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,self._user.sid)},SkylinkCC.prototype._privateMessageHandler=function(message){var targetMid=message.mid;message.callStatus?this._callStatusHandler(targetMid,message,!0):(log.log([targetMid,null,message.type,"Received private message from peer:"],message.data),this._trigger("incomingMessage",{content:message.data,isPrivate:!0,targetPeerId:message.target,isDataChannel:!1,senderPeerId:targetMid},targetMid,this._peerInformations[targetMid],!1))},SkylinkCC.prototype._publicMessageHandler=function(message){var targetMid=message.mid;message.callStatus?this._callStatusHandler(targetMid,message,!1):(log.log([targetMid,null,message.type,"Received public message from peer:"],message.data),this._trigger("incomingMessage",{content:message.data,isPrivate:!1,targetPeerId:null,isDataChannel:!1,senderPeerId:targetMid},targetMid,this._peerInformations[targetMid],!1))},SkylinkCC.prototype._callStatusHandler=function(targetMid,message,isPrivate){var call=message.data,checkPrivate=call.status>=this.CALL_READY_STATE.REQUEST_CALL?call.targetPeerId===this._user.sid:!0;isPrivate&&checkPrivate?(this._peerInformations[targetMid].call=call,this._user.info.call.status=call.status,this._trigger("peerCallRequest",targetMid,this._peerInformations[targetMid],!1)):isPrivate?log.error([message.mid,"CallStatus",call.status,"Dropped request because targetPeerId does not match"],call):(this._peerInformations[message.sender].call=call,call.peerType===this.PEER_TYPE.AGENT&&this._trigger("peerCallRequest",targetMid,this._peerInformations[targetMid],!1))},SkylinkCC.prototype.startPeerEvent=function(userData,event){var self=this;for(var e in this._EVENTS)if(this._EVENTS[e]===event.name)return void log.error("You cannot call a Skyway event.");event.name?setTimeout(function(){self.setUserData(userData),self._trigger(event.name,event.params)},200):log.error("No event name is provided")},SkylinkCC.prototype._handleCall=function(peerId,options,callback){return this._user?this._user.info?this._user.info.call?this._user.info.call.peerType!==options.peerType?void log.error("Peer type is not "+options.peerType+'. Peer type is: "'+this._user.info.call.peerType):(this._user.info.call.status=options.status||this._user.info.call.status,this._user.info.call.targetPeerId=options.targetPeerId||this._user.info.call.targetPeerId,this._user.info.call.targetRoom=options.targetRoom||this._user.info.call.targetRoom||null,this._sendChannelMessage({cid:this._key,mid:this._user.sid,rid:this._room.id,data:this._user.info.call,target:peerId,type:this._SIG_MESSAGE_TYPE.PRIVATE_MESSAGE,callStatus:!0}),this._trigger("peerCallRequest",this._user.sid,this._user.info,!0),void(callback&&callback())):void log.error('"_user.info.call" object is not loaded yet. Check readyState.'):void log.error('"_user.info" object is not loaded yet. Check readyState.'):void log.error('"_user" object is not loaded yet. Check readyState.')},SkylinkCC.prototype.agentRequestCall=function(clientPeerId,room){this._handleCall(clientPeerId,{status:this.CALL_READY_STATE.REQUEST_CALL,targetPeerId:clientPeerId,targetRoom:room||clientPeerId,peerType:this.PEER_TYPE.AGENT})},SkylinkCC.prototype.acceptRequestCall=function(agentPeerId,accept){this._handleCall(agentPeerId,{status:accept?this.CALL_READY_STATE.ACCEPTED_CALL:this.CALL_READY_STATE.REJECTED_CALL,targetPeerId:agentPeerId,targetRoom:this._peerInformations[agentPeerId].call.targetRoom,peerType:this.PEER_TYPE.CLIENT})},SkylinkCC.prototype.startRequestCall=function(targetPeerId,callback){var peerInfo,self=this,doLeaveRoom=function(){var userInfo=self._user.info;self.leaveRoom(),self._in_lobby=!1,self._temp.userCall=userInfo.call,self._temp.userData=userInfo.userData,callback(userInfo,peerInfo)};self._user.info.call.peerType===self.PEER_TYPE.AGENT?this._handleCall(targetPeerId,{status:self.CALL_READY_STATE.START_CALL,targetPeerId:targetPeerId,peerType:this.PEER_TYPE.AGENT},function(){peerInfo=self._peerInformations[targetPeerId],setTimeout(function(){doLeaveRoom()},3500)}):(peerInfo=self._peerInformations[targetPeerId],doLeaveRoom())},SkylinkCC.prototype._EVENTS.peerCallRequest=[],SkywayCC=SkylinkCC}).call(this);